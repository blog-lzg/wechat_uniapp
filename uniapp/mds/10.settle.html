<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>10. 登录与支付 | uniapp</title>
    <meta name="description" content="uniapp文档">
    <link rel="stylesheet" href="/wechat_uniapp/assets/style.f6f19f7b.css">
    <link rel="modulepreload" href="/wechat_uniapp/assets/plugin-vue_export-helper.abe1cdd2.js">
    <link rel="modulepreload" href="/wechat_uniapp/assets/Home.1920082e.js">
    <link rel="modulepreload" href="/wechat_uniapp/assets/AlgoliaSearchBox.e91bcfb3.js">
    <link rel="modulepreload" href="/wechat_uniapp/assets/uniapp_mds_10.settle.md.56f45d55.lean.js">
    <link rel="modulepreload" href="/wechat_uniapp/assets/app.14e14257.js">
    
    <meta name="twitter:title" content="10. 登录与支付 | uniapp">
  <meta property="og:title" content="10. 登录与支付 | uniapp">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/wechat_uniapp/" aria-label="uniapp, back to home" data-v-675d8756 data-v-4a583abe><!----> uniapp</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/wechat_uniapp/" data-v-b8818f8c>Guide <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/wechat_uniapp/config/basics" data-v-b8818f8c>Config Reference <!----></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--[--><div class="algolia-search-box" id="docsearch"></div><!--]--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/wechat_uniapp/" data-v-b8818f8c>Guide <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/wechat_uniapp/config/basics" data-v-b8818f8c>Config Reference <!----></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/wechat_uniapp/uniapp/mds/mds">uniapp</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/wechat_uniapp/uniapp/mds/1.start.html">1.起步</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/wechat_uniapp/uniapp/mds/2.tabbar.html">2.tabBar</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/wechat_uniapp/uniapp/mds/3.home.html">3.首页</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/wechat_uniapp/uniapp/mds/4.cate.html">4.分类</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/wechat_uniapp/uniapp/mds/5.search.html">5.搜索</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/wechat_uniapp/uniapp/mds/6.goodslist.html">6.商品列表</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/wechat_uniapp/uniapp/mds/7.goodsdetail.html">7.商品详情</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/wechat_uniapp/uniapp/mds/8.add2cart.html">8.加入购物车</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/wechat_uniapp/uniapp/mds/9.cart.html">9.购物车页面</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/wechat_uniapp/uniapp/mds/10.settle.html">10.登录与支付</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-0-创建-settle-分支">10.0 创建 settle 分支</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-1-点击结算按钮进行条件判断">10.1 点击结算按钮进行条件判断</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-2-登录">10.2 登录</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-2-1-定义-my-页面的编译模式">10.2.1 定义 my 页面的编译模式</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-2-2-实现登录和用户信息组件的按需展示">10.2.2 实现登录和用户信息组件的按需展示</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-2-3-实现登录组件的基本布局">10.2.3 实现登录组件的基本布局</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-2-4-点击登录按钮获取微信用户的基本信息">10.2.4 点击登录按钮获取微信用户的基本信息</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-2-5-将用户的基本信息存储到-vuex">10.2.5 将用户的基本信息存储到 vuex</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-2-6-登录获取-token-字符串">10.2.6 登录获取 Token 字符串</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-2-7-将-token-存储到-vuex">10.2.7 将 Token 存储到 vuex</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-3-用户信息">10.3 用户信息</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-3-1-实现用户头像昵称区域的基本布局">10.3.1 实现用户头像昵称区域的基本布局</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-3-2-渲染用户的头像和昵称">10.3.2 渲染用户的头像和昵称</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-3-3-渲染第一个面板区域">10.3.3 渲染第一个面板区域</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-3-4-渲染第二个面板区域">10.3.4 渲染第二个面板区域</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-3-5-渲染第三个面板区域">10.3.5 渲染第三个面板区域</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-3-6-实现退出登录的功能">10.3.6 实现退出登录的功能</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-4-三秒后自动跳转">10.4 三秒后自动跳转</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-4-1-三秒后自动跳转到登录页面">10.4.1 三秒后自动跳转到登录页面</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-4-2-登录成功之后再返回之前的页面">10.4.2 登录成功之后再返回之前的页面</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-5-微信支付">10.5 微信支付</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-5-1-在请求头中添加-token-身份认证的字段">10.5.1 在请求头中添加 Token 身份认证的字段</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-5-2-微信支付的流程">10.5.2 微信支付的流程</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-5-3-创建订单">10.5.3 创建订单</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-5-4-订单预支付">10.5.4 订单预支付</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-5-5-发起微信支付">10.5.5 发起微信支付</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_10-6-分支的合并与提交">10.6 分支的合并与提交</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/wechat_uniapp/uniapp/mds/11.publish.html">11.发布</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="_10-登录与支付" tabindex="-1">10. 登录与支付 <a class="header-anchor" href="#_10-登录与支付" aria-hidden="true">#</a></h1><h2 id="_10-0-创建-settle-分支" tabindex="-1">10.0 创建 settle 分支 <a class="header-anchor" href="#_10-0-创建-settle-分支" aria-hidden="true">#</a></h2><p>运行如下的命令，基于 <code>master</code> 分支在本地创建 <code>settle</code> 子分支，用来开发登录与支付相关的功能：</p><div class="language-bash line-numbers-mode"><pre><code><span class="token function">git</span> checkout -b settle
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_10-1-点击结算按钮进行条件判断" tabindex="-1">10.1 点击结算按钮进行条件判断 <a class="header-anchor" href="#_10-1-点击结算按钮进行条件判断" aria-hidden="true">#</a></h2><blockquote><p>说明：用户点击了结算按钮之后，需要先后判断<strong>是否勾选了要结算的商品</strong>、<strong>是否选择了收货地址</strong>、<strong>是否登录</strong>。</p></blockquote><ol><li><p>在 <code>my-settle</code> 组件中，为结算按钮绑定点击事件处理函数：</p><div class="language-xml line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><br></div><pre><code><span class="token comment">&lt;!-- 结算按钮 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn-settle<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>settlement<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>结算({{checkedCount}})<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li><li><p>在 <code>my-settle</code> 组件的 methods 节点中声明 settlement 事件处理函数如下：</p><div class="language-js line-numbers-mode"><pre><code><span class="token comment">// 点击了结算按钮</span>
<span class="token function">settlement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 先判断是否勾选了要结算的商品</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>checkedCount<span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;请选择要结算的商品！&#39;</span><span class="token punctuation">)</span>

  <span class="token comment">// 2. 再判断用户是否选择了收货地址</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>addstr<span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;请选择收货地址！&#39;</span><span class="token punctuation">)</span>

  <span class="token comment">// 3. 最后判断用户是否登录了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;请先登录！&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li><li><p>在 <code>my-settle</code> 组件中，使用 <code>mapGetters</code> 辅助函数，从 <code>m_user</code> 模块中将 <code>addstr</code> 映射到当前组件中使用：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">computed</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token function">mapGetters</span><span class="token punctuation">(</span><span class="token string">&#39;m_cart&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;total&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;checkedCount&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;checkedGoodsAmount&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// addstr 是详细的收货地址</span>
    <span class="token operator">...</span><span class="token function">mapGetters</span><span class="token punctuation">(</span><span class="token string">&#39;m_user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;addstr&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">isFullCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>total <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>checkedCount
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li><li><p>在 <code>store/user.js</code> 模块的 <code>state</code> 节点中，声明 <code>token</code> 字符串：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br></div><pre><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token comment">// 开启命名空间</span>
  <span class="token literal-property property">namespaced</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

  <span class="token comment">// state 数据</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 收货地址</span>
    <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>uni<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">&#39;address&#39;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;{}&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 登录成功之后的 token 字符串</span>
    <span class="token literal-property property">token</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token comment">// 省略其它代码</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li><li><p>在 <code>my-settle</code> 组件中，使用 <code>mapState</code> 辅助函数，从 <code>m_user</code> 模块中将 <code>token</code> 映射到当前组件中使用：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre><code><span class="token comment">// 按需从 vuex 中导入 mapState 辅助函数</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mapGetters<span class="token punctuation">,</span> mapMutations<span class="token punctuation">,</span> mapState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vuex&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">computed</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token function">mapGetters</span><span class="token punctuation">(</span><span class="token string">&#39;m_cart&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;total&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;checkedCount&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;checkedGoodsAmount&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token function">mapGetters</span><span class="token punctuation">(</span><span class="token string">&#39;m_user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;addstr&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// token 是用户登录成功之后的 token 字符串</span>
    <span class="token operator">...</span><span class="token function">mapState</span><span class="token punctuation">(</span><span class="token string">&#39;m_user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;token&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">isFullCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>total <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>checkedCount
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li></ol><h2 id="_10-2-登录" tabindex="-1">10.2 登录 <a class="header-anchor" href="#_10-2-登录" aria-hidden="true">#</a></h2><h3 id="_10-2-1-定义-my-页面的编译模式" tabindex="-1">10.2.1 定义 my 页面的编译模式 <a class="header-anchor" href="#_10-2-1-定义-my-页面的编译模式" aria-hidden="true">#</a></h3><ol><li><p>点击 <code>微信开发者工具</code> 工具栏上的编译模式下拉菜单，选择 <code>添加编译模式</code>：</p><p><img src="/wechat_uniapp/assets/10-3.3f4cc8fd.png" alt=""></p></li><li><p>勾选启动页面的路径之后，点击确定按钮：</p><p><img src="/wechat_uniapp/assets/10-4.15b8f275.png" alt=""></p></li></ol><h3 id="_10-2-2-实现登录和用户信息组件的按需展示" tabindex="-1">10.2.2 实现登录和用户信息组件的按需展示 <a class="header-anchor" href="#_10-2-2-实现登录和用户信息组件的按需展示" aria-hidden="true">#</a></h3><ol><li><p>在 <code>components</code> 目录中新建<strong>登录组件</strong>：</p><p><img src="/wechat_uniapp/assets/10-1.c2fe9868.png" alt=""></p></li><li><p>在 <code>components</code> 目录中新建<strong>用户信息组件</strong>：</p><p><img src="/wechat_uniapp/assets/10-2.111f2081.png" alt=""></p></li><li><p>在 <code>my.vue</code> 页面中，通过 <code>mapState</code> 辅助函数，导入需要的 <code>token</code> 字符串：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre><code><span class="token keyword">import</span> badgeMix <span class="token keyword">from</span> <span class="token string">&#39;@/mixins/tabbar-badge.js&#39;</span>
<span class="token comment">// 1. 从 vuex 中按需导入 mapState 辅助函数</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mapState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vuex&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">mixins</span><span class="token operator">:</span> <span class="token punctuation">[</span>badgeMix<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">computed</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2. 从 m_user 模块中导入需要的 token 字符串</span>
    <span class="token operator">...</span><span class="token function">mapState</span><span class="token punctuation">(</span><span class="token string">&#39;m_user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;token&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li><li><p>在 <code>my.vue</code> 页面中，实现<strong>登录组件</strong>和<strong>用户信息组件</strong>的按需展示：</p><div class="language-xml line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 用户未登录时，显示登录组件 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-login</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>!token<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>my-login</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 用户登录后，显示用户信息组件 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-userinfo</span> <span class="token attr-name">v-else</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>my-userinfo</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li></ol><h3 id="_10-2-3-实现登录组件的基本布局" tabindex="-1">10.2.3 实现登录组件的基本布局 <a class="header-anchor" href="#_10-2-3-实现登录组件的基本布局" aria-hidden="true">#</a></h3><ol><li><p>为 <code>my-login</code> 组件定义如下的 UI 结构：</p><div class="language-xml line-numbers-mode"><pre><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>login-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 提示登录的图标 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uni-icons</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>contact-filled<span class="token punctuation">&quot;</span></span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100<span class="token punctuation">&quot;</span></span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#AFAFAF<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>uni-icons</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 登录按钮 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn-login<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>一键登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 登录提示 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tips-text<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>登录后尽享更多权益<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li><li><p>美化登录组件的样式：</p><div class="language-scss line-numbers-mode"><pre><code><span class="token selector">.login-container </span><span class="token punctuation">{</span>
  <span class="token comment">// 登录盒子的样式</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 750rpx<span class="token punctuation">;</span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>
  <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">justify-content</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #f8f8f8<span class="token punctuation">;</span>
  <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>

  <span class="token comment">// 绘制登录盒子底部的半椭圆造型</span>
  <span class="token selector"><span class="token parent important">&amp;</span>::after </span><span class="token punctuation">{</span>
    <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">;</span>
    <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
    <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 40px<span class="token punctuation">;</span>
    <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token property">bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">translateY</span><span class="token punctuation">(</span>50%<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 登录按钮的样式</span>
  <span class="token selector">.btn-login </span><span class="token punctuation">{</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 90%<span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
    <span class="token property">margin</span><span class="token punctuation">:</span> 15px 0<span class="token punctuation">;</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> #c00000<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 按钮下方提示消息的样式</span>
  <span class="token selector">.tips-text </span><span class="token punctuation">{</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 12px<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> gray<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div></li></ol><h3 id="_10-2-4-点击登录按钮获取微信用户的基本信息" tabindex="-1">10.2.4 点击登录按钮获取微信用户的基本信息 <a class="header-anchor" href="#_10-2-4-点击登录按钮获取微信用户的基本信息" aria-hidden="true">#</a></h3><blockquote><p>需求描述：需要获取微信用户的<strong>头像</strong>、<strong>昵称</strong>等基本信息。</p></blockquote><ol><li><p>为登录的 <code>button</code> 按钮绑定 <code>open-type=&quot;getUserInfo&quot;</code> 属性，表示点击按钮时，希望获取用户的基本信息：</p><div class="language-xml line-numbers-mode"><pre><code><span class="token comment">&lt;!-- 登录按钮 --&gt;</span>
<span class="token comment">&lt;!-- 可以从 @getuserinfo 事件处理函数的形参中，获取到用户的基本信息 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn-login<span class="token punctuation">&quot;</span></span> <span class="token attr-name">open-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getUserInfo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@getuserinfo</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getUserInfo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>一键登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li><li><p>在 <code>methods</code> 节点中声明 <code>getUserInfo</code> 事件处理函数如下：</p><div class="language-js line-numbers-mode"><pre><code><span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取微信用户的基本信息</span>
  <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取用户信息成功， e.detail.userInfo 就是用户的基本信息</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>userInfo<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ol><h3 id="_10-2-5-将用户的基本信息存储到-vuex" tabindex="-1">10.2.5 将用户的基本信息存储到 vuex <a class="header-anchor" href="#_10-2-5-将用户的基本信息存储到-vuex" aria-hidden="true">#</a></h3><ol><li><p>在 <code>store/user.js</code> 模块的 state 节点中，声明 <code>userinfo</code> 的信息对象如下：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre><code><span class="token comment">// state 数据</span>
<span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 收货地址</span>
  <span class="token comment">// address: {}</span>
  <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>uni<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">&#39;address&#39;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;{}&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 登录成功之后的 token 字符串</span>
  <span class="token literal-property property">token</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  <span class="token comment">// 用户的基本信息</span>
  <span class="token literal-property property">userinfo</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>uni<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">&#39;userinfo&#39;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;{}&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li><li><p>在 <code>store/user.js</code> 模块的 mutations 节点中，声明如下的两个方法：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre><code><span class="token comment">// 方法</span>
<span class="token literal-property property">mutations</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略其它代码...</span>

  <span class="token comment">// 更新用户的基本信息</span>
  <span class="token function">updateUserInfo</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> userinfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>userinfo <span class="token operator">=</span> userinfo
    <span class="token comment">// 通过 this.commit() 方法，调用 m_user 模块下的 saveUserInfoToStorage 方法，将 userinfo 对象持久化存储到本地</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">&#39;m_user/saveUserInfoToStorage&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 将 userinfo 持久化存储到本地</span>
  <span class="token function">saveUserInfoToStorage</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uni<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">&#39;userinfo&#39;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>userinfo<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li><li><p>使用 <code>mapMutations</code> 辅助函数，将需要的方法映射到 <code>my-login</code> 组件中使用：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre><code><span class="token comment">// 1. 按需导入 mapMutations 辅助函数</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mapMutations <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vuex&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2. 调用 mapMutations 辅助方法，把 m_user 模块中的 updateUserInfo 映射到当前组件中使用</span>
    <span class="token operator">...</span><span class="token function">mapMutations</span><span class="token punctuation">(</span><span class="token string">&#39;m_user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;updateUserInfo&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 获取微信用户的基本信息</span>
    <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取用户信息成功， e.detail.userInfo 就是用户的基本信息</span>
      <span class="token comment">// console.log(e.detail.userInfo)</span>

      <span class="token comment">// 3. 将用户的基本信息存储到 vuex 中</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateUserInfo</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>userInfo<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li></ol><h3 id="_10-2-6-登录获取-token-字符串" tabindex="-1">10.2.6 登录获取 Token 字符串 <a class="header-anchor" href="#_10-2-6-登录获取-token-字符串" aria-hidden="true">#</a></h3><blockquote><p>需求说明：当获取到了微信用户的基本信息之后，还需要进一步<strong>调用登录相关的接口</strong>，从而<strong>换取登录成功之后的 Token 字符串</strong>。</p></blockquote><ol><li><p>在 <code>getUserInfo</code> 方法中，预调用 <code>this.getToken()</code> 方法，同时把获取到的用户信息传递进去：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div></div><pre><code><span class="token comment">// 获取微信用户的基本信息</span>
<span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将用户的基本信息存储到 vuex 中</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateUserInfo</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>userInfo<span class="token punctuation">)</span>

  <span class="token comment">// 获取登录成功后的 Token 字符串</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>detail<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li><li><p>在 <code>methods</code> 中定义 <code>getToken</code> 方法，调用登录相关的 API，实现登录的功能：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre><code><span class="token comment">// 调用登录接口，换取永久的 token</span>
<span class="token keyword">async</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 调用微信登录接口</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>err<span class="token punctuation">,</span> res<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> uni<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> err<span class="token punctuation">)</span>
  <span class="token comment">// 判断是否 uni.login() 调用失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">||</span> res<span class="token punctuation">.</span>errMsg <span class="token operator">!==</span> <span class="token string">&#39;login:ok&#39;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showError</span><span class="token punctuation">(</span><span class="token string">&#39;登录失败！&#39;</span><span class="token punctuation">)</span>

  <span class="token comment">// 准备参数对象</span>
  <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">code</span><span class="token operator">:</span> res<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
    <span class="token literal-property property">encryptedData</span><span class="token operator">:</span> info<span class="token punctuation">.</span>encryptedData<span class="token punctuation">,</span>
    <span class="token literal-property property">iv</span><span class="token operator">:</span> info<span class="token punctuation">.</span>iv<span class="token punctuation">,</span>
    <span class="token literal-property property">rawData</span><span class="token operator">:</span> info<span class="token punctuation">.</span>rawData<span class="token punctuation">,</span>
    <span class="token literal-property property">signature</span><span class="token operator">:</span> info<span class="token punctuation">.</span>signature
  <span class="token punctuation">}</span>

  <span class="token comment">// 换取 token</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> loginResult <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> uni<span class="token punctuation">.</span>$http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/public/v1/users/wxlogin&#39;</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>loginResult<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;登录失败！&#39;</span><span class="token punctuation">)</span>
  uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;登录成功&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div></li></ol><h3 id="_10-2-7-将-token-存储到-vuex" tabindex="-1">10.2.7 将 Token 存储到 vuex <a class="header-anchor" href="#_10-2-7-将-token-存储到-vuex" aria-hidden="true">#</a></h3><ol><li><p>在 <code>store/user.js</code> 模块的 <code>mutations</code> 节点中，声明如下的两个方法：</p><div class="language-js line-numbers-mode"><pre><code><span class="token literal-property property">mutations</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略其它代码...</span>

  <span class="token comment">// 更新 token 字符串</span>
  <span class="token function">updateToken</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> token</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>token <span class="token operator">=</span> token
    <span class="token comment">// 通过 this.commit() 方法，调用 m_user 模块下的 saveTokenToStorage 方法，将 token 字符串持久化存储到本地</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">&#39;m_user/saveTokenToStorage&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 将 token 字符串持久化存储到本地</span>
  <span class="token function">saveTokenToStorage</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uni<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">&#39;token&#39;</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>token<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li><li><p>修改 <code>store/user.js</code> 模块的 <code>state</code> 节点如下：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre><code><span class="token comment">// state 数据</span>
<span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 收货地址</span>
  <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>uni<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">&#39;address&#39;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;{}&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 登录成功之后的 token 字符串</span>
  <span class="token literal-property property">token</span><span class="token operator">:</span> uni<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">&#39;token&#39;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  <span class="token comment">// 用户的基本信息</span>
  <span class="token literal-property property">userinfo</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>uni<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">&#39;userinfo&#39;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;{}&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li><li><p>在 <code>my-login</code> 组件中，把 vuex 中的 <code>updateToken</code> 方法映射到当前组件中使用：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre><code><span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 使用 mapMutations 辅助方法，把 m_user 模块中的 updateToken 方法映射到当前组件中使用</span>
  <span class="token operator">...</span><span class="token function">mapMutations</span><span class="token punctuation">(</span><span class="token string">&#39;m_user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;updateUserInfo&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;updateToken&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token comment">// 省略其它代码...</span>

  <span class="token comment">// 调用登录接口，换取永久的 token</span>
  <span class="token keyword">async</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用微信登录接口</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>err<span class="token punctuation">,</span> res<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> uni<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> err<span class="token punctuation">)</span>
    <span class="token comment">// 判断是否 uni.login() 调用失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">||</span> res<span class="token punctuation">.</span>errMsg <span class="token operator">!==</span> <span class="token string">&#39;login:ok&#39;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showError</span><span class="token punctuation">(</span><span class="token string">&#39;登录失败！&#39;</span><span class="token punctuation">)</span>

    <span class="token comment">// 准备参数对象</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">code</span><span class="token operator">:</span> res<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
      <span class="token literal-property property">encryptedData</span><span class="token operator">:</span> info<span class="token punctuation">.</span>encryptedData<span class="token punctuation">,</span>
      <span class="token literal-property property">iv</span><span class="token operator">:</span> info<span class="token punctuation">.</span>iv<span class="token punctuation">,</span>
      <span class="token literal-property property">rawData</span><span class="token operator">:</span> info<span class="token punctuation">.</span>rawData<span class="token punctuation">,</span>
      <span class="token literal-property property">signature</span><span class="token operator">:</span> info<span class="token punctuation">.</span>signature
    <span class="token punctuation">}</span>

    <span class="token comment">// 换取 token</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> loginResult <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> uni<span class="token punctuation">.</span>$http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/public/v1/users/wxlogin&#39;</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loginResult<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;登录失败！&#39;</span><span class="token punctuation">)</span>

    <span class="token comment">// 2. 更新 vuex 中的 token</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateToken</span><span class="token punctuation">(</span>loginResult<span class="token punctuation">.</span>message<span class="token punctuation">.</span>token<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div></li></ol><h2 id="_10-3-用户信息" tabindex="-1">10.3 用户信息 <a class="header-anchor" href="#_10-3-用户信息" aria-hidden="true">#</a></h2><h3 id="_10-3-1-实现用户头像昵称区域的基本布局" tabindex="-1">10.3.1 实现用户头像昵称区域的基本布局 <a class="header-anchor" href="#_10-3-1-实现用户头像昵称区域的基本布局" aria-hidden="true">#</a></h3><ol><li><p>在 <code>my-userinfo</code> 组件中，定义如下的 UI 结构：</p><div class="language-xml line-numbers-mode"><pre><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>my-userinfo-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 头像昵称区域 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>top-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>avatar<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nickname<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>xxx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li><li><p>美化当前组件的样式：</p><div class="language-scss line-numbers-mode"><pre><code><span class="token selector">.my-userinfo-container </span><span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token comment">// 为整个组件的结构添加浅灰色的背景</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #f4f4f4<span class="token punctuation">;</span>

  <span class="token selector">.top-box </span><span class="token punctuation">{</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 400rpx<span class="token punctuation">;</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> #c00000<span class="token punctuation">;</span>
    <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
    <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>
    <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    <span class="token property">justify-content</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>

    <span class="token selector">.avatar </span><span class="token punctuation">{</span>
      <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
      <span class="token property">width</span><span class="token punctuation">:</span> 90px<span class="token punctuation">;</span>
      <span class="token property">height</span><span class="token punctuation">:</span> 90px<span class="token punctuation">;</span>
      <span class="token property">border-radius</span><span class="token punctuation">:</span> 45px<span class="token punctuation">;</span>
      <span class="token property">border</span><span class="token punctuation">:</span> 2px solid white<span class="token punctuation">;</span>
      <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 1px 5px black<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token selector">.nickname </span><span class="token punctuation">{</span>
      <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
      <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
      <span class="token property">font-size</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>
      <span class="token property">margin-top</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div></li><li><p>在 <code>my.vue</code> 页面中，为最外层包裹性质的 <code>view</code> 容器，添加 <code>class=&quot;my-container&quot;</code> 的类名，并美化样式如下：</p><div class="language-scss line-numbers-mode"><pre><code><span class="token selector">page,
.my-container </span><span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ol><h3 id="_10-3-2-渲染用户的头像和昵称" tabindex="-1">10.3.2 渲染用户的头像和昵称 <a class="header-anchor" href="#_10-3-2-渲染用户的头像和昵称" aria-hidden="true">#</a></h3><ol><li><p>在 <code>my-userinfo</code> 组件中，通过 <code>mapState</code> 辅助函数，将需要的成员映射到当前组件中使用：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre><code><span class="token comment">// 按需导入 mapState 辅助函数</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mapState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vuex&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">computed</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将 m_user 模块中的 userinfo 映射到当前页面中使用</span>
    <span class="token operator">...</span><span class="token function">mapState</span><span class="token punctuation">(</span><span class="token string">&#39;m_user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;userinfo&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li><li><p>将用户的头像和昵称渲染到页面中：</p><div class="language-xml line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre><code><span class="token comment">&lt;!-- 头像昵称区域 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>top-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">:src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userinfo.avatarUrl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>avatar<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nickname<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{userinfo.nickName}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ol><h3 id="_10-3-3-渲染第一个面板区域" tabindex="-1">10.3.3 渲染第一个面板区域 <a class="header-anchor" href="#_10-3-3-渲染第一个面板区域" aria-hidden="true">#</a></h3><ol><li><p>在 <code>my-userinfo</code> 组件中，定义如下的 UI 结构：</p><div class="language-xml line-numbers-mode"><pre><code><span class="token comment">&lt;!-- 面板的列表区域 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 第一个面板 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- panel 的主体区域 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-body<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- panel 的 item 项 --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>收藏的店铺<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>14<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>收藏的商品<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>18<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>关注的商品<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>84<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>足迹<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- 第二个面板 --&gt;</span>

  <span class="token comment">&lt;!-- 第三个面板 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div></li><li><p>美化第一个面板的样式：</p><div class="language-scss line-numbers-mode"><pre><code><span class="token selector">.panel-list </span><span class="token punctuation">{</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 0 10px<span class="token punctuation">;</span>
  <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> -10px<span class="token punctuation">;</span>

  <span class="token selector">.panel </span><span class="token punctuation">{</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 3px<span class="token punctuation">;</span>
    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>

    <span class="token selector">.panel-body </span><span class="token punctuation">{</span>
      <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
      <span class="token property">justify-content</span><span class="token punctuation">:</span> space-around<span class="token punctuation">;</span>

      <span class="token selector">.panel-item </span><span class="token punctuation">{</span>
        <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
        <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>
        <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
        <span class="token property">justify-content</span><span class="token punctuation">:</span> space-around<span class="token punctuation">;</span>
        <span class="token property">font-size</span><span class="token punctuation">:</span> 13px<span class="token punctuation">;</span>
        <span class="token property">padding</span><span class="token punctuation">:</span> 10px 0<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div></li></ol><h3 id="_10-3-4-渲染第二个面板区域" tabindex="-1">10.3.4 渲染第二个面板区域 <a class="header-anchor" href="#_10-3-4-渲染第二个面板区域" aria-hidden="true">#</a></h3><ol><li><p>定义第二个面板区域的 UI 结构：</p><div class="language-xml line-numbers-mode"><pre><code><span class="token comment">&lt;!-- 第二个面板 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 面板的标题 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我的订单<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 面板的主体 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-body<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 面板主体中的 item 项 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/my-icons/icon1.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>icon<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>待付款<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/my-icons/icon2.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>icon<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>待收货<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/my-icons/icon3.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>icon<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>退款/退货<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/my-icons/icon4.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>icon<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>全部订单<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div></li><li><p>对之前的 SCSS 样式进行改造，从而美化第二个面板的样式：</p><div class="language-scss line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br></div><pre><code><span class="token selector">.panel-list </span><span class="token punctuation">{</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 0 10px<span class="token punctuation">;</span>
  <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> -10px<span class="token punctuation">;</span>

  <span class="token selector">.panel </span><span class="token punctuation">{</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 3px<span class="token punctuation">;</span>
    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>

    <span class="token selector">.panel-title </span><span class="token punctuation">{</span>
      <span class="token property">line-height</span><span class="token punctuation">:</span> 45px<span class="token punctuation">;</span>
      <span class="token property">padding-left</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
      <span class="token property">font-size</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>
      <span class="token property">border-bottom</span><span class="token punctuation">:</span> 1px solid #f4f4f4<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token selector">.panel-body </span><span class="token punctuation">{</span>
      <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
      <span class="token property">justify-content</span><span class="token punctuation">:</span> space-around<span class="token punctuation">;</span>

      <span class="token selector">.panel-item </span><span class="token punctuation">{</span>
        <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
        <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>
        <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
        <span class="token property">justify-content</span><span class="token punctuation">:</span> space-around<span class="token punctuation">;</span>
        <span class="token property">font-size</span><span class="token punctuation">:</span> 13px<span class="token punctuation">;</span>
        <span class="token property">padding</span><span class="token punctuation">:</span> 10px 0<span class="token punctuation">;</span>

        <span class="token selector">.icon </span><span class="token punctuation">{</span>
          <span class="token property">width</span><span class="token punctuation">:</span> 35px<span class="token punctuation">;</span>
          <span class="token property">height</span><span class="token punctuation">:</span> 35px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div></li></ol><h3 id="_10-3-5-渲染第三个面板区域" tabindex="-1">10.3.5 渲染第三个面板区域 <a class="header-anchor" href="#_10-3-5-渲染第三个面板区域" aria-hidden="true">#</a></h3><ol><li><p>定义第三个面板区域的 UI 结构：</p><div class="language-xml line-numbers-mode"><pre><code><span class="token comment">&lt;!-- 第三个面板 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-list-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>收货地址<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uni-icons</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>arrowright<span class="token punctuation">&quot;</span></span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>15<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>uni-icons</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-list-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>联系客服<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uni-icons</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>arrowright<span class="token punctuation">&quot;</span></span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>15<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>uni-icons</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-list-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>退出登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uni-icons</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>arrowright<span class="token punctuation">&quot;</span></span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>15<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>uni-icons</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li><li><p>美化第三个面板区域的样式：</p><div class="language-scss line-numbers-mode"><pre><code><span class="token selector">.panel-list-item </span><span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 45px<span class="token punctuation">;</span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  <span class="token property">justify-content</span><span class="token punctuation">:</span> space-between<span class="token punctuation">;</span>
  <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 0 10px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ol><h3 id="_10-3-6-实现退出登录的功能" tabindex="-1">10.3.6 实现退出登录的功能 <a class="header-anchor" href="#_10-3-6-实现退出登录的功能" aria-hidden="true">#</a></h3><ol><li><p>为第三个面板区域中的 <code>退出登录</code> 项绑定 <code>click</code> 点击事件处理函数：</p><div class="language-xml line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br></div><pre><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>panel-list-item<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>logout<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>退出登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uni-icons</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>arrowright<span class="token punctuation">&quot;</span></span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>15<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>uni-icons</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p>在 <code>my-userinfo</code> 组件的 <code>methods</code> 节点中定义 <code>logout</code> 事件处理函数：</p><div class="language-js line-numbers-mode"><pre><code><span class="token comment">// 退出登录</span>
<span class="token keyword">async</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 询问用户是否退出登录</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>err<span class="token punctuation">,</span> succ<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> uni<span class="token punctuation">.</span><span class="token function">showModal</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;提示&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">&#39;确认退出登录吗？&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> err<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>succ <span class="token operator">&amp;&amp;</span> succ<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 用户确认了退出登录的操作</span>
     <span class="token comment">// 需要清空 vuex 中的 userinfo、token 和 address</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateToken</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateAddress</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li><li><p>使用 <code>mapMutations</code> 辅助方法，将需要用到的 mutations 方法映射到当前组件中：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><br></div><pre><code><span class="token comment">// 按需导入辅助函数</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mapState<span class="token punctuation">,</span> mapMutations <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vuex&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token function">mapMutations</span><span class="token punctuation">(</span><span class="token string">&#39;m_user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;updateUserInfo&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;updateToken&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;updateAddress&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ol><h2 id="_10-4-三秒后自动跳转" tabindex="-1">10.4 三秒后自动跳转 <a class="header-anchor" href="#_10-4-三秒后自动跳转" aria-hidden="true">#</a></h2><h3 id="_10-4-1-三秒后自动跳转到登录页面" tabindex="-1">10.4.1 三秒后自动跳转到登录页面 <a class="header-anchor" href="#_10-4-1-三秒后自动跳转到登录页面" aria-hidden="true">#</a></h3><blockquote><p>需求描述：在购物车页面，当用户点击 “结算” 按钮时，<strong>如果用户没有登录，则 3 秒后自动跳转到登录页面</strong></p></blockquote><ol><li><p>在 <code>my-settle</code> 组件的 <code>methods</code> 节点中，声明一个叫做 <code>showTips</code> 的方法，专门用来展示倒计时的提示消息：</p><div class="language-js line-numbers-mode"><pre><code><span class="token comment">// 展示倒计时的提示消息</span>
<span class="token function">showTips</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 调用 uni.showToast() 方法，展示提示消息</span>
  uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 不展示任何图标</span>
    <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">&#39;none&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">// 提示的消息</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;请登录后再结算！&#39;</span> <span class="token operator">+</span> n <span class="token operator">+</span> <span class="token string">&#39; 秒后自动跳转到登录页&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">// 为页面添加透明遮罩，防止点击穿透</span>
    <span class="token literal-property property">mask</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 1.5 秒后自动消失</span>
    <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">1500</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li><li><p>在 <code>data</code> 节点中声明倒计时的秒数：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre><code><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token comment">// 倒计时的秒数</span>
    <span class="token literal-property property">seconds</span><span class="token operator">:</span> <span class="token number">3</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li><li><p>改造 <code>结算</code> 按钮的 <code>click</code> 事件处理函数，如果用户没有登录，则<strong>预调用</strong>一个叫做 <code>delayNavigate</code> 的方法，进行倒计时的导航跳转：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre><code><span class="token comment">// 点击了结算按钮</span>
<span class="token function">settlement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 先判断是否勾选了要结算的商品</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>checkedCount<span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;请选择要结算的商品！&#39;</span><span class="token punctuation">)</span>

  <span class="token comment">// 2. 再判断用户是否选择了收货地址</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>addstr<span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;请选择收货地址！&#39;</span><span class="token punctuation">)</span>

  <span class="token comment">// 3. 最后判断用户是否登录了，如果没有登录，则调用 delayNavigate() 进行倒计时的导航跳转</span>
  <span class="token comment">// if (!this.token) return uni.$showMsg(&#39;请先登录！&#39;)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">delayNavigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li><li><p>定义 <code>delayNavigate</code> 方法，初步实现<strong>倒计时的提示功能</strong>：</p><div class="language-js line-numbers-mode"><pre><code><span class="token comment">// 延迟导航到 my 页面</span>
<span class="token function">delayNavigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 展示提示消息，此时 seconds 的值等于 3</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showTips</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seconds<span class="token punctuation">)</span>

  <span class="token comment">// 2. 创建定时器，每隔 1 秒执行一次</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2.1 先让秒数自减 1</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>seconds<span class="token operator">--</span>
    <span class="token comment">// 2.2 再根据最新的秒数，进行消息提示</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showTips</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seconds<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><p>上述代码的问题：<strong>定时器不会自动停止</strong>，此时秒数会出现等于 0 或小于 0 的情况！</p></blockquote></li><li><p>在 <code>data</code> 节点中声明定时器的 Id 如下：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre><code><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token comment">// 倒计时的秒数</span>
    <span class="token literal-property property">seconds</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token comment">// 定时器的 Id</span>
    <span class="token literal-property property">timer</span><span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li><li><p>改造 <code>delayNavigate</code> 方法如下：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br></div><pre><code><span class="token comment">// 延迟导航到 my 页面</span>
<span class="token function">delayNavigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showTips</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seconds<span class="token punctuation">)</span>

  <span class="token comment">// 1. 将定时器的 Id 存储到 timer 中</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>seconds<span class="token operator">--</span>

    <span class="token comment">// 2. 判断秒数是否 &lt;= 0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seconds <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2.1 清除定时器</span>
      <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span>

      <span class="token comment">// 2.2 跳转到 my 页面</span>
      uni<span class="token punctuation">.</span><span class="token function">switchTab</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;/pages/my/my&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token comment">// 2.3 终止后续代码的运行（当秒数为 0 时，不再展示 toast 提示消息）</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showTips</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seconds<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><blockquote><p>上述代码的问题：<strong>seconds 秒数不会被重置</strong>，导致第 2 次，3 次，n 次 的倒计时跳转功能无法正常工作</p></blockquote></li><li><p>进一步改造 <code>delayNavigate</code> 方法，在执行此方法时，立即将 <code>seconds</code> 秒数重置为 <code>3</code> 即可：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre><code><span class="token comment">// 延迟导航到 my 页面</span>
<span class="token function">delayNavigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 把 data 中的秒数重置成 3 秒</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>seconds <span class="token operator">=</span> <span class="token number">3</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showTips</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seconds<span class="token punctuation">)</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>seconds<span class="token operator">--</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seconds <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span>
      uni<span class="token punctuation">.</span><span class="token function">switchTab</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;/pages/my/my&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showTips</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seconds<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li></ol><h3 id="_10-4-2-登录成功之后再返回之前的页面" tabindex="-1">10.4.2 登录成功之后再返回之前的页面 <a class="header-anchor" href="#_10-4-2-登录成功之后再返回之前的页面" aria-hidden="true">#</a></h3><blockquote><p>核心实现思路：在自动跳转到登录页面成功之后，把<strong>返回页面的信息存储到 vuex 中</strong>，从而方便登录成功之后，根据返回页面的信息重新跳转回去。</p></blockquote><blockquote><p>返回页面的信息对象，<strong>主要包含 { openType, from } 两个属性</strong>，其中 openType 表示<strong>以哪种方式导航回之前的页面</strong>；from 表示<strong>之前页面的 url 地址</strong>；</p></blockquote><ol><li><p>在 <code>store/user.js</code> 模块的 <code>state</code> 节点中，声明一个叫做 <code>redirectInfo</code> 的对象如下：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre><code><span class="token comment">// state 数据</span>
<span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 收货地址</span>
  <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>uni<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">&#39;address&#39;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;{}&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 登录成功之后的 token 字符串</span>
  <span class="token literal-property property">token</span><span class="token operator">:</span> uni<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">&#39;token&#39;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  <span class="token comment">// 用户的基本信息</span>
  <span class="token literal-property property">userinfo</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>uni<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">&#39;userinfo&#39;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;{}&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 重定向的 object 对象 { openType, from }</span>
  <span class="token literal-property property">redirectInfo</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li><li><p>在 <code>store/user.js</code> 模块的 <code>mutations</code> 节点中，声明一个叫做 <code>updateRedirectInfo</code> 的方法：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre><code><span class="token literal-property property">mutations</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// 更新重定向的信息对象</span>
  <span class="token function">updateRedirectInfo</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>redirectInfo <span class="token operator">=</span> info
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li><li><p>在 <code>my-settle</code> 组件中，通过 <code>mapMutations</code> 辅助方法，把 <code>m_user</code> 模块中的 <code>updateRedirectInfo</code> 方法映射到当前页面中使用：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre><code><span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// 把 m_user 模块中的 updateRedirectInfo 方法映射到当前页面中使用</span>
  <span class="token operator">...</span><span class="token function">mapMutations</span><span class="token punctuation">(</span><span class="token string">&#39;m_user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;updateRedirectInfo&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p>改造 <code>my-settle</code> 组件 methods 节点中的 <code>delayNavigate</code> 方法，当成功跳转到 <code>my 页面</code> 之后，将重定向的信息对象存储到 vuex 中：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br></div><pre><code><span class="token comment">// 延迟导航到 my 页面</span>
<span class="token function">delayNavigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 把 data 中的秒数重置成 3 秒</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>seconds <span class="token operator">=</span> <span class="token number">3</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showTips</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seconds<span class="token punctuation">)</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>seconds<span class="token operator">--</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seconds <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 清除定时器</span>
      <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span>
      <span class="token comment">// 跳转到 my 页面</span>
      uni<span class="token punctuation">.</span><span class="token function">switchTab</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;/pages/my/my&#39;</span><span class="token punctuation">,</span>
        <span class="token comment">// 页面跳转成功之后的回调函数</span>
        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 调用 vuex 的 updateRedirectInfo 方法，把跳转信息存储到 Store 中</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateRedirectInfo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">// 跳转的方式</span>
            <span class="token literal-property property">openType</span><span class="token operator">:</span> <span class="token string">&#39;switchTab&#39;</span><span class="token punctuation">,</span>
            <span class="token comment">// 从哪个页面跳转过去的</span>
            <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token string">&#39;/pages/cart/cart&#39;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showTips</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seconds<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div></li><li><p>在 <code>my-login</code> 组件中，通过 <code>mapState</code> 和 <code>mapMutations</code> 辅助方法，将 vuex 中需要的数据和方法，映射到当前页面中使用：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><br></div><pre><code><span class="token comment">// 按需导入辅助函数</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mapMutations<span class="token punctuation">,</span> mapState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vuex&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">computed</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用 mapState 辅助方法，把 m_user 模块中的数据映射到当前用组件中使用</span>
    <span class="token operator">...</span><span class="token function">mapState</span><span class="token punctuation">(</span><span class="token string">&#39;m_user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;redirectInfo&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用 mapMutations 辅助方法，把 m_user 模块中的方法映射到当前组件中使用</span>
    <span class="token operator">...</span><span class="token function">mapMutations</span><span class="token punctuation">(</span><span class="token string">&#39;m_user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;updateUserInfo&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;updateToken&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;updateRedirectInfo&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li><li><p>改造 <code>my-login</code> 组件中的 <code>getToken</code> 方法，当登录成功之后，预调用 <code>this.navigateBack()</code> 方法返回登录之前的页面：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre><code><span class="token comment">// 调用登录接口，换取永久的 token</span>
<span class="token keyword">async</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略其它代码...</span>

  <span class="token comment">// 判断 vuex 中的 redirectInfo 是否为 null</span>
  <span class="token comment">// 如果不为 null，则登录成功之后，需要重新导航到对应的页面</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li><li><p>在 <code>my-login</code> 组件中，声明 <code>navigateBack</code> 方法如下：</p><div class="language-js line-numbers-mode"><pre><code><span class="token comment">// 返回登录之前的页面</span>
<span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// redirectInfo 不为 null，并且导航方式为 switchTab</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>redirectInfo <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redirectInfo<span class="token punctuation">.</span>openType <span class="token operator">===</span> <span class="token string">&#39;switchTab&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用小程序提供的 uni.switchTab() API 进行页面的导航</span>
    uni<span class="token punctuation">.</span><span class="token function">switchTab</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 要导航到的页面地址</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redirectInfo<span class="token punctuation">.</span>from<span class="token punctuation">,</span>
      <span class="token comment">// 导航成功之后，把 vuex 中的 redirectInfo 对象重置为 null</span>
      <span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateRedirectInfo</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li></ol><h2 id="_10-5-微信支付" tabindex="-1">10.5 微信支付 <a class="header-anchor" href="#_10-5-微信支付" aria-hidden="true">#</a></h2><h3 id="_10-5-1-在请求头中添加-token-身份认证的字段" tabindex="-1">10.5.1 在请求头中添加 Token 身份认证的字段 <a class="header-anchor" href="#_10-5-1-在请求头中添加-token-身份认证的字段" aria-hidden="true">#</a></h3><ol><li><p>原因说明：<strong>只有在登录之后才允许调用支付相关的接口</strong>，所以必须为有权限的接口添加身份认证的请求头字段</p></li><li><p>打开项目根目录下的 <code>main.js</code>，改造 <code>$http.beforeRequest</code> 请求拦截器中的代码如下：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre><code><span class="token comment">// 请求开始之前做一些事情</span>
$http<span class="token punctuation">.</span><span class="token function-variable function">beforeRequest</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  uni<span class="token punctuation">.</span><span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;数据加载中...&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 判断请求的是否为有权限的 API 接口</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;/my/&#39;</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 为请求头添加身份认证字段</span>
    options<span class="token punctuation">.</span>header <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">// 字段的值可以直接从 vuex 中进行获取</span>
      <span class="token literal-property property">Authorization</span><span class="token operator">:</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>m_user<span class="token punctuation">.</span>token<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li></ol><h3 id="_10-5-2-微信支付的流程" tabindex="-1">10.5.2 微信支付的流程 <a class="header-anchor" href="#_10-5-2-微信支付的流程" aria-hidden="true">#</a></h3><ol><li><p><strong>创建订单</strong></p><ul><li><p>请求创建订单的 API 接口：把（订单金额、收货地址、订单中包含的商品信息）发送到服务器</p></li><li><p>服务器响应的结果：<em>订单编号</em></p></li></ul></li><li><p><strong>订单预支付</strong></p><ul><li><p>请求订单预支付的 API 接口：把（订单编号）发送到服务器</p></li><li><p>服务器响应的结果：<em>订单预支付的参数对象</em>，里面包含了订单支付相关的必要参数</p></li></ul></li><li><p><strong>发起微信支付</strong></p><ul><li><p>调用 <code>uni.requestPayment()</code> 这个 API，发起微信支付；把步骤 2 得到的 “订单预支付对象” 作为参数传递给 <code>uni.requestPayment()</code> 方法</p></li><li><p>监听 <code>uni.requestPayment()</code> 这个 API 的 <code>success</code>，<code>fail</code>，<code>complete</code> 回调函数</p></li></ul></li></ol><h3 id="_10-5-3-创建订单" tabindex="-1">10.5.3 创建订单 <a class="header-anchor" href="#_10-5-3-创建订单" aria-hidden="true">#</a></h3><ol><li><p>改造 <code>my-settle</code> 组件中的 <code>settlement</code> 方法，当前三个判断条件通过之后，调用实现微信支付的方法：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre><code><span class="token comment">// 点击了结算按钮</span>
<span class="token function">settlement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 先判断是否勾选了要结算的商品</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>checkedCount<span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;请选择要结算的商品！&#39;</span><span class="token punctuation">)</span>

  <span class="token comment">// 2. 再判断用户是否选择了收货地址</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>addstr<span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;请选择收货地址！&#39;</span><span class="token punctuation">)</span>

  <span class="token comment">// 3. 最后判断用户是否登录了</span>
  <span class="token comment">// if (!this.token) return uni.$showMsg(&#39;请先登录！&#39;)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">delayNavigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 4. 实现微信支付功能</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">payOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li><li><p>在 <code>my-settle</code> 组件中定义 <code>payOrder</code> 方法如下，先实现创建订单的功能：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><br><br></div><pre><code><span class="token comment">// 微信支付</span>
<span class="token keyword">async</span> <span class="token function">payOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 创建订单</span>
  <span class="token comment">// 1.1 组织订单的信息对象</span>
  <span class="token keyword">const</span> orderInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开发期间，注释掉真实的订单价格，</span>
    <span class="token comment">// order_price: this.checkedGoodsAmount,</span>
    <span class="token comment">// 写死订单总价为 1 分钱</span>
    <span class="token literal-property property">order_price</span><span class="token operator">:</span> <span class="token number">0.01</span><span class="token punctuation">,</span>
    <span class="token literal-property property">consignee_addr</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>addstr<span class="token punctuation">,</span>
    <span class="token literal-property property">goods</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cart<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>goods_state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">goods_id</span><span class="token operator">:</span> x<span class="token punctuation">.</span>goods_id<span class="token punctuation">,</span> <span class="token literal-property property">goods_number</span><span class="token operator">:</span> x<span class="token punctuation">.</span>goods_count<span class="token punctuation">,</span> <span class="token literal-property property">goods_price</span><span class="token operator">:</span> x<span class="token punctuation">.</span>goods_price <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 1.2 发起请求创建订单</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> res <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> uni<span class="token punctuation">.</span>$http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/public/v1/my/orders/create&#39;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;创建订单失败！&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 1.3 得到服务器响应的“订单编号”</span>
  <span class="token keyword">const</span> orderNumber <span class="token operator">=</span> res<span class="token punctuation">.</span>message<span class="token punctuation">.</span>order_number

   <span class="token comment">// 2. 订单预支付</span>

   <span class="token comment">// 3. 发起微信支付</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></li></ol><h3 id="_10-5-4-订单预支付" tabindex="-1">10.5.4 订单预支付 <a class="header-anchor" href="#_10-5-4-订单预支付" aria-hidden="true">#</a></h3><ol><li><p>改造 <code>my-settle</code> 组件的 <code>payOrder</code> 方法，实现订单预支付功能：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre><code><span class="token comment">// 微信支付</span>
<span class="token keyword">async</span> <span class="token function">payOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 创建订单</span>
  <span class="token comment">// 1.1 组织订单的信息对象</span>
  <span class="token keyword">const</span> orderInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开发期间，注释掉真实的订单价格，</span>
    <span class="token comment">// order_price: this.checkedGoodsAmount,</span>
    <span class="token comment">// 写死订单总价为 1 分钱</span>
    <span class="token literal-property property">order_price</span><span class="token operator">:</span> <span class="token number">0.01</span><span class="token punctuation">,</span>
    <span class="token literal-property property">consignee_addr</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>addstr<span class="token punctuation">,</span>
    <span class="token literal-property property">goods</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cart<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>goods_state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">goods_id</span><span class="token operator">:</span> x<span class="token punctuation">.</span>goods_id<span class="token punctuation">,</span> <span class="token literal-property property">goods_number</span><span class="token operator">:</span> x<span class="token punctuation">.</span>goods_count<span class="token punctuation">,</span> <span class="token literal-property property">goods_price</span><span class="token operator">:</span> x<span class="token punctuation">.</span>goods_price <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 1.2 发起请求创建订单</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> res <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> uni<span class="token punctuation">.</span>$http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/public/v1/my/orders/create&#39;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;创建订单失败！&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 1.3 得到服务器响应的“订单编号”</span>
  <span class="token keyword">const</span> orderNumber <span class="token operator">=</span> res<span class="token punctuation">.</span>message<span class="token punctuation">.</span>order_number

  <span class="token comment">// 2. 订单预支付</span>
  <span class="token comment">// 2.1 发起请求获取订单的支付信息</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> res2 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> uni<span class="token punctuation">.</span>$http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/public/v1/my/orders/req_unifiedorder&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">order_number</span><span class="token operator">:</span> orderNumber <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 2.2 预付订单生成失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res2<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showError</span><span class="token punctuation">(</span><span class="token string">&#39;预付订单生成失败！&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 2.3 得到订单支付相关的必要参数</span>
  <span class="token keyword">const</span> payInfo <span class="token operator">=</span> res2<span class="token punctuation">.</span>message<span class="token punctuation">.</span>pay

   <span class="token comment">// 3. 发起微信支付</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div></li></ol><h3 id="_10-5-5-发起微信支付" tabindex="-1">10.5.5 发起微信支付 <a class="header-anchor" href="#_10-5-5-发起微信支付" aria-hidden="true">#</a></h3><ol><li><p>改造 <code>my-settle</code> 组件的 <code>payOrder</code> 方法，实现微信支付的功能：</p><div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre><code><span class="token comment">// 微信支付</span>
<span class="token keyword">async</span> <span class="token function">payOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 创建订单</span>
  <span class="token comment">// 1.1 组织订单的信息对象</span>
  <span class="token keyword">const</span> orderInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开发期间，注释掉真实的订单价格，</span>
    <span class="token comment">// order_price: this.checkedGoodsAmount,</span>
    <span class="token comment">// 写死订单总价为 1 分钱</span>
    <span class="token literal-property property">order_price</span><span class="token operator">:</span> <span class="token number">0.01</span><span class="token punctuation">,</span>
    <span class="token literal-property property">consignee_addr</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>addstr<span class="token punctuation">,</span>
    <span class="token literal-property property">goods</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cart<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>goods_state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">goods_id</span><span class="token operator">:</span> x<span class="token punctuation">.</span>goods_id<span class="token punctuation">,</span> <span class="token literal-property property">goods_number</span><span class="token operator">:</span> x<span class="token punctuation">.</span>goods_count<span class="token punctuation">,</span> <span class="token literal-property property">goods_price</span><span class="token operator">:</span> x<span class="token punctuation">.</span>goods_price <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 1.2 发起请求创建订单</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> res <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> uni<span class="token punctuation">.</span>$http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/public/v1/my/orders/create&#39;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;创建订单失败！&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 1.3 得到服务器响应的“订单编号”</span>
  <span class="token keyword">const</span> orderNumber <span class="token operator">=</span> res<span class="token punctuation">.</span>message<span class="token punctuation">.</span>order_number

   <span class="token comment">// 2. 订单预支付</span>
   <span class="token comment">// 2.1 发起请求获取订单的支付信息</span>
   <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> res2 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> uni<span class="token punctuation">.</span>$http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/public/v1/my/orders/req_unifiedorder&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">order_number</span><span class="token operator">:</span> orderNumber <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token comment">// 2.2 预付订单生成失败</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>res2<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showError</span><span class="token punctuation">(</span><span class="token string">&#39;预付订单生成失败！&#39;</span><span class="token punctuation">)</span>
   <span class="token comment">// 2.3 得到订单支付相关的必要参数</span>
   <span class="token keyword">const</span> payInfo <span class="token operator">=</span> res2<span class="token punctuation">.</span>message<span class="token punctuation">.</span>pay

   <span class="token comment">// 3. 发起微信支付</span>
   <span class="token comment">// 3.1 调用 uni.requestPayment() 发起微信支付</span>
   <span class="token keyword">const</span> <span class="token punctuation">[</span>err<span class="token punctuation">,</span> succ<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> uni<span class="token punctuation">.</span><span class="token function">requestPayment</span><span class="token punctuation">(</span>payInfo<span class="token punctuation">)</span>
   <span class="token comment">// 3.2 未完成支付</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;订单未支付！&#39;</span><span class="token punctuation">)</span>
   <span class="token comment">// 3.3 完成了支付，进一步查询支付的结果</span>
   <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> res3 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> uni<span class="token punctuation">.</span>$http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/public/v1/my/orders/chkOrder&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">order_number</span><span class="token operator">:</span> orderNumber <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token comment">// 3.4 检测到订单未支付</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>res3<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">return</span> uni<span class="token punctuation">.</span><span class="token function">$showMsg</span><span class="token punctuation">(</span><span class="token string">&#39;订单未支付！&#39;</span><span class="token punctuation">)</span>
   <span class="token comment">// 3.5 检测到订单支付完成</span>
   uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
     <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;支付完成！&#39;</span><span class="token punctuation">,</span>
     <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">&#39;success&#39;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div></li></ol><h2 id="_10-6-分支的合并与提交" tabindex="-1">10.6 分支的合并与提交 <a class="header-anchor" href="#_10-6-分支的合并与提交" aria-hidden="true">#</a></h2><ol><li><p>将 <code>settle</code> 分支进行本地提交：</p><div class="language-bash line-numbers-mode"><pre><code><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit -m <span class="token string">&quot;完成了登录和支付功能的开发&quot;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li><li><p>将本地的 <code>settle</code> 分支推送到码云：</p><div class="language-bash line-numbers-mode"><pre><code><span class="token function">git</span> push -u origin settle
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li><li><p>将本地 <code>settle</code> 分支中的代码合并到 <code>master</code> 分支：</p><div class="language-bash line-numbers-mode"><pre><code><span class="token function">git</span> checkout master
<span class="token function">git</span> merge settle
<span class="token function">git</span> push
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li><li><p>删除本地的 <code>settle</code> 分支：</p><div class="language-bash line-numbers-mode"><pre><code><span class="token function">git</span> branch -d settle
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-fb8d84c6><div class="edit" data-v-fb8d84c6><div class="edit-link" data-v-fb8d84c6 data-v-1ed99556><!----></div></div><div class="updated" data-v-fb8d84c6><p class="last-updated" data-v-fb8d84c6 data-v-5797b537><span class="prefix" data-v-5797b537>上次更新:</span><span class="datetime" data-v-5797b537></span></p></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/wechat_uniapp/uniapp/mds/9.cart" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>9.购物车页面</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/wechat_uniapp/uniapp/mds/11.publish" data-v-38ede35f><span class="text" data-v-38ede35f>11.发布</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"c172618c\",\"uniapp_mds_1.start.md\":\"edcbb714\",\"uniapp_mds_10.settle.md\":\"56f45d55\",\"uniapp_mds_11.publish.md\":\"3ccc30fa\",\"uniapp_mds_2.tabbar.md\":\"7a94d57d\",\"uniapp_mds_3.home.md\":\"f3d22d82\",\"uniapp_mds_4.cate.md\":\"8046f855\",\"uniapp_mds_5.search.md\":\"bc020c5b\",\"uniapp_mds_6.goodslist.md\":\"a59c6904\",\"uniapp_mds_7.goodsdetail.md\":\"3f23ae34\",\"uniapp_mds_8.add2cart.md\":\"d48ac617\",\"uniapp_mds_9.cart.md\":\"a8cdc138\"}")</script>
    <script type="module" async src="/wechat_uniapp/assets/app.14e14257.js"></script>
    
  </body>
</html>